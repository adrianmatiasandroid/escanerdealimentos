<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Ingredientes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.5/tesseract.min.js"></script>
    <style>
        /* [Estilos anteriores se mantienen igual] */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Analizador de Ingredientes</h1>
            <p>Escanea los ingredientes de tus productos</p>
        </header>

        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <input type="text" id="barcodeInput" placeholder="Ingresa código de barras" class="button" style="margin-bottom: 10px;">
        <button id="startCamera" class="button">Iniciar Cámara</button>
        <button id="captureImage" class="button" disabled>Capturar Imagen</button>
        <button id="analyzeImage" class="button" disabled>Analizar Ingredientes</button>
        <button id="searchBarcode" class="button">Buscar por Código</button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Buscando información...</p>
        </div>

        <div id="error" class="error-message" style="display: none;"></div>
        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startButton = document.getElementById('startCamera');
        const captureButton = document.getElementById('captureImage');
        const analyzeButton = document.getElementById('analyzeImage');
        const searchBarcodeButton = document.getElementById('searchBarcode');
        const barcodeInput = document.getElementById('barcodeInput');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const resultsDiv = document.getElementById('results');

        let stream = null;

        // Base de datos de ingredientes veganos y puntuación de salud
        const veganDatabase = {
            'soja': true,
            'trigo': true,
            'maíz': true,
            'arroz': true,
            'azúcar': true,
            'leche': false,
            'huevo': false,
            'carne': false,
            'pollo': false,
            'pescado': false
        };

        const healthScoreMap = {
            'azúcar': 2,
            'sal': 4,
            'aceite': 3,
            'conservantes': 3,
            'frutas': 9,
            'verduras': 10,
            'carne procesada': 2,
            'granos integrales': 8,
            'legumbres': 9
        };

        // Función para buscar producto en Open Food Facts
        async function fetchProductData(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();

                if (data.status === 1) {
                    return data.product;
                } else {
                    throw new Error('Producto no encontrado');
                }
            } catch (error) {
                console.error('Error al buscar producto:', error);
                showError('No se pudo encontrar información del producto');
                return null;
            }
        }

        // Analizar ingredientes
        function analyzeIngredients(ingredientsList) {
            return ingredientsList.map(ingredient => {
                const ingredientLower = ingredient.toLowerCase();
                
                // Determinar si es vegano
                const isVegan = Object.keys(veganDatabase).some(key => 
                    ingredientLower.includes(key.toLowerCase())
                ) ? veganDatabase[Object.keys(veganDatabase).find(key => 
                    ingredientLower.includes(key.toLowerCase())
                )] : null;

                // Calcular puntuación de salud
                const healthScore = Object.keys(healthScoreMap).reduce((score, key) => {
                    return ingredientLower.includes(key.toLowerCase()) 
                        ? healthScoreMap[key] 
                        : score;
                }, 5); // Valor por defecto

                return {
                    name: ingredient,
                    vegan: isVegan,
                    health_score: healthScore,
                    description: `Ingrediente: ${ingredient}`
                };
            });
        }

        // Mostrar resultados
        function displayProductResults(product) {
            resultsDiv.innerHTML = `
                <h2>${product.product_name || 'Producto sin nombre'}</h2>
                <p>Marca: ${product.brands || 'No especificada'}</p>
                <p>Código de Barras: ${product.code}</p>
                <h3>Ingredientes:</h3>
            `;

            if (product.ingredients_text) {
                const ingredients = product.ingredients_text.split(',');
                const analyzedIngredients = analyzeIngredients(ingredients);

                analyzedIngredients.forEach(ingredient => {
                    const healthScoreColor = ingredient.health_score <= 3 ? '#f44336' : 
                                              ingredient.health_score <= 6 ? '#ff9800' : 
                                              '#4CAF50';

                    resultsDiv.innerHTML += `
                        <div class="ingredient-item">
                            <div class="ingredient-name">
                                ${ingredient.name}
                                ${ingredient.vegan !== null ? 
                                    `<span class="${ingredient.vegan ? 'vegan-tag' : 'non-vegan-tag'}">
                                        ${ingredient.vegan ? 'Vegano' : 'No Vegano'}
                                    </span>` : ''
                                }
                                <span class="score" style="background-color: ${healthScoreColor}">
                                    Salud: ${ingredient.health_score}/10
                                </span>
                            </div>
                        </div>
                    `;
                });
            } else {
                resultsDiv.innerHTML += '<p>No se encontraron ingredientes</p>';
            }

            resultsDiv.style.display = 'block';
        }

        // Mostrar error
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            loadingDiv.style.display = 'none';
        }

        // Evento para buscar por código de barras
        searchBarcodeButton.addEventListener('click', async () => {
            const barcode = barcodeInput.value.trim();
            
            if (!barcode) {
                showError('Por favor ingresa un código de barras');
                return;
            }

            try {
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                const product = await fetchProductData(barcode);
                
                if (product) {
                    displayProductResults(product);
                }
            } catch (error) {
                showError('Error al buscar el producto');
            } finally {
                loadingDiv.style.display = 'none';
            }
        });

        // Iniciar la cámara (código anterior se mantiene igual)
        startButton.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                video.style.display = 'block';
                startButton.disabled = true;
                captureButton.disabled = false;
                errorDiv.style.display = 'none';
            } catch (err) {
                showError('Error al acceder a la cámara. Por favor, asegúrate de dar los permisos necesarios.');
            }
        });

        // Capturar imagen (código anterior se mantiene igual)
        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            captureButton.disabled = true;
            analyzeButton.disabled = false;

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Analizar imagen con OCR
        analyzeButton.addEventListener('click', async () => {
            try {
                loadingDiv.style.display = 'block';
                analyzeButton.disabled = true;
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                const result = await Tesseract.recognize(canvas, 'spa');
                const text = result.data.text.toLowerCase();
                
                // Intentar extraer código de barras si es posible
                const barcodeMatch = text.match(/\d{13}/);
                
                if (barcodeMatch) {
                    barcodeInput.value = barcodeMatch[0];
                    const product = await fetchProductData(barcodeMatch[0]);
                    
                    if (product) {
                        displayProductResults(product);
                    }
                } else {
                    showError('No se pudo encontrar un código de barras válido');
                }
            } catch (err) {
                showError('Error al analizar la imagen. Por favor, intenta de nuevo.');
            } finally {
                loadingDiv.style.display = 'none';
            }
        });
    </script>
</body>
</html>